name: Cloud Webhook Test

on:
  push:
    branches: [ 'simulate/webhook' ]

jobs:
  run-webhook-test:
    runs-on: ubuntu-latest
    steps:
      - name: Print runner info
        run: |
          echo "Runner: $(uname -a)"
          echo "Date (UTC): $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "curl version:"
          curl --version || true
          echo "GITHUB_RUN_ID=${GITHUB_RUN_ID}"
      - name: Run curl to SignalHouse webhook and capture output
        env:
          SIGNALHOUSE_TOKEN: ${{ secrets.SIGNALHOUSE_TEST_TOKEN }}
        continue-on-error: true
        run: |
          echo "Posting test payload to SignalHouse webhook endpoint"
          cat > payload.json <<'JSON'
{
  "event": "message.received",
  "from": "+15551231234",
  "to": "+15164079249",
  "text": "Yes, I'm interested",
  "message_id": "gha-msg-123",
  "timestamp": "2026-01-28T00:00:00Z",
  "campaign_id": "CJRCU60"
}
JSON
          printf "\n--- CURL VERBOSE OUTPUT ---\n" > curl.log
          curl -v -k -H "Authorization: Bearer ${SIGNALHOUSE_TOKEN}" -H "Content-Type: application/json" -H "X-Debug-Webhook: run-${GITHUB_RUN_ID}" --data @payload.json "https://monkfish-app-mb7h3.ondigitalocean.app/api/webhook/signalhouse" >> curl.log 2>&1 || true
          printf "\n--- HTTP STATUS ---\n" >> curl.log
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -k -H "Authorization: Bearer ${SIGNALHOUSE_TOKEN}" -H "Content-Type: application/json" --data @payload.json "https://monkfish-app-mb7h3.ondigitalocean.app/api/webhook/signalhouse" ) || HTTP_STATUS="000"
          echo "$HTTP_STATUS" >> curl.log
          echo "Saved curl.log"
      - name: Dump curl.log to workflow logs
        if: always()
        run: |
          echo "=== BEGIN curl.log ==="
          cat curl.log || echo "curl.log not created"
          echo "=== END curl.log ==="
      - name: Upload curl log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cloud-webhook-curl-log
          path: curl.log
