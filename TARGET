# TARGET ARCHITECTURE VISUALIZATION
## Nextier Platform - "Lean & Mean" Design

```mermaid
graph TB
    subgraph "USER INTERFACE LAYER"
        UI[Unified Next.js Frontend]
        CMD[Command Palette Navigation]
        WFB[Visual Workflow Builder]
    end

    subgraph "API GATEWAY LAYER"
        GW[API Gateway<br/>50 Routes (from 170)]
        RL[Rate Limiting]
        AUTH[Authentication<br/>userId + teamId]
    end

    subgraph "SERVICE LAYER"
        LEAD[Lead Service<br/>Core CRUD + Operations]
        CAMP[Campaign Service<br/>Multi-channel Orchestration]
        AI[AI Service<br/>OpenAI + Anthropic]
        ENR[Enrichment Service<br/>Apollo + Property APIs]
    end

    subgraph "DATA LAYER"
        DB[(PostgreSQL<br/>with RLS)]
        CACHE[(Redis Cache)]
        QUEUE[(Job Queue)]
        STORAGE[(Object Storage)]
    end

    subgraph "EXTERNAL INTEGRATIONS"
        APOLLO[Apollo.io<br/>$0.10/record]
        PROP[Property APIs]
        SMS[SignalHouse SMS]
        VOICE[Twilio Voice]
    end

    subgraph "MONITORING & OBSERVABILITY"
        LOGS[Structured Logging]
        METRICS[Performance Metrics]
        ALERTS[Alerting System]
        TRACES[Distributed Tracing]
    end

    %% Flow connections
    UI --> GW
    CMD --> GW
    WFB --> GW
    
    GW --> LEAD
    GW --> CAMP
    GW --> AI
    GW --> ENR
    
    LEAD --> DB
    CAMP --> DB
    AI --> DB
    ENR --> DB
    
    AI --> CACHE
    ENR --> QUEUE
    
    LEAD --> APOLLO
    ENR --> PROP
    CAMP --> SMS
    CAMP --> VOICE
    
    DB --> STORAGE
    
    %% Monitoring
    GW --> LOGS
    LEAD --> METRICS
    AI --> TRACES
    METRICS --> ALERTS

    classDef critical fill:#ff6b6b,stroke:#333,stroke-width:3px,color:#fff
    classDef optimized fill:#4ecdc4,stroke:#333,stroke-width:2px,color:#fff
    classDef external fill:#95e1d3,stroke:#333,stroke-width:1px,color:#333

    class AUTH,DB critical
    class GW,LEAD,CAMP,AI,ENR optimized
    class APOLLO,PROP,SMS,VOICE external
```

## CURRENT vs OPTIMIZED ARCHITECTURE

### CURRENT STATE (Problems)
```
❌ 170+ API Routes (sprawl)
❌ 5 AI Providers (cost waste)
❌ 29 Database Schemas (complexity)
❌ 512MB RAM instances (insufficient)
❌ Single-node DB (no HA)
❌ No RLS (security risk)
❌ globalThis storage (data loss)
❌ Upstash 250/batch limit (scale blocker)
```

### OPTIMIZED STATE (Lean & Mean)
```
✅ 50 API Routes (consolidated)
✅ 2 AI Providers (cost optimized)
✅ 15 Core Schemas (simplified)
✅ 2GB+ RAM instances (reliable)
✅ Multi-node DB with HA (scalable)
✅ Row-Level Security (secure)
✅ Persistent storage (reliable)
✅ Redis cluster (unlimited scale)
```

## CORE USER JOURNEY FLOWS

### 1. Lead Management Journey
```mermaid
graph LR
    A[Import CSV] --> B[Enrich Pipeline]
    B --> C[Score & Qualify]
    C --> D[Assign to Campaign]
    D --> E[Monitor Performance]
    
    B --> F[Apollo Enrichment]
    B --> G[Property Data]
    B --> H[Skip Trace]
    
    C --> I[AI Scoring]
    I --> J[Auto-Assignment]
```

### 2. Campaign Execution Journey
```mermaid
graph LR
    A[Design Campaign] --> B[Configure Sequences]
    B --> C[Launch Campaign]
    C --> D[Monitor Responses]
    D --> E[AI Auto-Response]
    E --> F[Human Review]
    F --> G[Optimize Campaign]
    
    C --> H[SMS via SignalHouse]
    C --> I[Voice via Twilio]
    C --> J[Email via SendGrid]
    
    D --> K[Universal Inbox]
    K --> L[AI Classification]
```

## AI INFRASTRUCTURE OPTIMIZATION

### Current AI Provider Chaos
```
OpenAI GPT-4    $0.002/request  (Primary)
Anthropic       $0.003/request  (Backup)
Google AI       $0.001/request  (Unused)
Grok AI         $0.005/request  (Unused)
LangChain       $0.010/request  (Over-engineered)
```

### Optimized AI Stack
```
OpenAI GPT-4o   $0.002/request  (Primary - Best Value)
Anthropic Claude $0.003/request (Backup - Best Quality)

Benefits:
- 70% cost reduction
- Simplified architecture
- Better performance
- Easier maintenance
```

## DATABASE ARCHITECTURE SIMPLIFICATION

### Core Schema Consolidation (29 → 15)
```
REMAINING (Core):
✅ teams - Multi-tenant isolation
✅ users - User management
✅ leads - Core lead data
✅ campaigns - Campaign orchestration
✅ messages - Communication tracking
✅ properties - Real estate data
✅ integrations - External connections
✅ ai_sdr_avatars - AI personas
✅ workflows - Automation flows
✅ inbox - Universal inbox
✅ content_library - Templates
✅ achievements - Gamification
✅ prompts - AI prompts
✅ phone_numbers - Contact data
✅ email_addresses - Contact data

CONSOLIDATED/REMOVED (14 schemas):
❌ Redundant entity schemas
❌ Over-specific schemas
❌ Legacy migration schemas
```

## PERFORMANCE OPTIMIZATION TARGETS

### Response Time Improvements
```
API Endpoints:
Current: 200-2000ms → Target: <100ms
- Database query optimization
- Redis caching layer
- Connection pooling
- Query result caching

Database Queries:
Current: 500-2000ms → Target: <50ms
- Proper indexing strategy
- Query plan optimization
- Connection pooling
- Read replicas

AI Generation:
Current: 2-10s → Target: <1s
- Provider optimization
- Response caching
- Batch processing
- Parallel execution
```

## SECURITY ARCHITECTURE

### Multi-Tenant Security Model
```sql
-- Row-Level Security Implementation
CREATE POLICY tenant_isolation ON leads
  USING (team_id = current_setting('app.current_team_id')::text);

-- Team Context Setting
SET app.current_team_id = 'team_123';
SELECT * FROM leads; -- Only team_123 data
```

### Authentication Flow
```
1. User Login → JWT Token (userId + teamId)
2. API Request → Validate JWT + Extract teamId
3. Database Query → RLS Policy filters by teamId
4. Response → Filtered data for specific team only
```

## COST OPTIMIZATION BREAKDOWN

### Annual Savings Projection
```
AI Provider Consolidation:
Before: $120,000/year (5 providers)
After: $36,000/year (2 providers)
Savings: $84,000/year (70%)

Infrastructure Right-Sizing:
Before: $24,000/year (: $48,000/year (properunderpowered)
After sizing)
Investment: +$24,000/year (100% increase for reliability)

Monitoring & Observability:
Before: $0/year (no monitoring)
After: $6,000/year (comprehensive)
Investment: +$6,000/year

Net Savings: $54,000/year (45% reduction)
ROI: 225% in first year
```

## SCALABILITY ARCHITECTURE

### Horizontal Scaling Strategy
```
Load Balancer → Multiple API Instances
                ↓
            Redis Cluster (Shared State)
                ↓
            PostgreSQL Cluster (Master-Slave)
                ↓
            Background Workers (BullMQ)
```

### Auto-Scaling Configuration
```yaml
api:
  min_instances: 2
  max_instances: 10
  cpu_threshold: 70%
  memory_threshold: 80%

database:
  read_replicas: 3
  connection_pooling: enabled
  query_caching: enabled

cache:
  redis_cluster: 3 nodes
  eviction_policy: LRU
  ttl_optimization: enabled
```

---

This visualization provides a clear roadmap for transforming the current complex architecture into a lean, mean, and scalable system that focuses on the core components that matter most for powering the Nextier platform effectively.